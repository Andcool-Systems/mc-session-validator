# Minecraft Session Validator

Сервис, который предназначен для прохождения первых этапов входа на Minecraft сервер. Этот сервис, как и [mc-oauth](https://mc-oauth.andcool.ru) создан для использования его в сторонних проектах. Однако его отличие заключается в том, что он реализует не сервер, а клиент. При создании запроса ему нужно передать accessToken сессии Minecraft, никнейм и UUID, а так же данные о желаемом сервере.

## Как это работает и зачем это нужно?
Помимо проверки аккаунта на лицензионность, он так же проверяет, может ли данный клиент присоединиться к требуемому серверу. Это полезно при создании проектов, требующих от клиента нахождения их в белом списке сервере.

### Как работает вход?
Сервер имеет реализацию клиентской стороны фазы логина Minecraft Protocol. При создании запроса через REST API, он пытается подключиться к переданному серверу **от лица клиента**. Он проходит этапы авторизации через сервера Mojang для подтверждения лицензионности своей сессии. Однако, он не может полностью пройти процесс входа на сервер, так как в сервисе намеренно не реализован пакет `login_acknowledged`, что не дает серверу заспавнить игрового персонажа. Вместо этого, после успешного прохождения всех заданных этапов, клиент отключается от сервера, возвращая в API данные, которые он получил от сервера.    

Если по каким-либо причинам ему не удается подключиться к серверу, будь то невалидная сессия или разрыв соединения с сервером, клиент вернёт в API ошибку, которая будет содержать подробности отключения от сервера.

### Для кого это полезно?
Этот сервис разрабатывался как часть другого, более крупного проекта, который при регистрации требует от профиля Minecraft его нахождения в вайтлисте определенного сервера.

## Задуманная реализация
Этот сервис не должен быть доступен публично, для предотвращения DOS атак на сервера Minecraft. Вместо этого, он должен быть запущен на локальном интерфейсе, а доступ к нему должен осуществляться через другой API враппер.    

Обращения к врапперу должен осуществлять Minecraft мод, который так же будет осуществлять аутентификацию на уровне API враппера. Мод должен получить у клиента accessToken, имя пользователя и его UUID и отправить на промежуточный API. API, в свою очередь должен сделать `POST` запрос на этот сервис с данными, которые он получил от клиента.

> [!WARNING]
> НАШ СЕРВИС НЕ СОБИРАЕТ ВАШИ ЛИЧНЫЕ ДАННЫЕ! ВСЕ ТОКЕНЫ ДОСТУПА УДАЛЯЮТСЯ СРАЗУ ПОСЛЕ ВЫПОЛНЕНИЯ ПОПЫТКИ ПОДКЛЮЧЕНИЯ К СЕРВИСУ. ТАКЖЕ СЕРВИС НЕ МОЖЕТ ПОДКЛЮЧИТЬСЯ К СЕРВЕРУ ВМЕСТО ВАС, ТАК КАК ЭТО НЕ ВХОДИТ В ЕГО ЗАДАЧИ. ОДНАКО МЫ НЕ НЕСЕМ ОТВЕТСТВЕННОСТИ ЗА ВСЕ СТОРОННИЕ МОДИФИКАЦИИ НАШЕГО СЕРВИСА, СТОРОННИЕ API ИЛИ МОДЫ!!! ВСЕ ДОВЕРЕННЫЕ ПРОЕКТЫ, КОТОРЫЕ ДОБРОСОВЕСТНО ВЫПОЛНЯЮТ ТРЕБОВАНИЯ КОНФИДЕНЦИАЛЬНОСТИ НАШИХ ПОЛЬЗОВАТЕЛЕЙ БУДУТ ОПУБЛИКОВАНЫ В САМОМ КОНЦЕ ЭТОГО ФАЙЛА.

## Работа с API
Чтобы выполнить запрос на сервер, сделайте `POST` запрос на эндпоинт `/connect` с JSON в теле запроса.

```json
{
    "accessToken": "<accessToken>",
    "nickname": "AndcoolSystems",
    "UUID": "1420c63c-b111-4453-993f-b3479ba1d4c6",
    "server": {
        "ip": "mycoolserver.net",
        "port": 25565,
        "protocolVersion": 769
    }
}
```

- `accessToken` – Должен содержать токен клиента. (В моде на Fabric его можно получить здесь `MinecraftClient.getInstance().getSession().getAccessToken()`)
- `nickname` – Никнейм аккаунта. Должен совпадать с тем, который установлен в вашем профиле Minecraft
- `UUID` – UUID профиля Minecraft. Обязательно должен иметь тире.
- `server`
  - `ip` – IP сервера для подключения. Может быть как IP, так и доменом
  - `port` – Порт сервера
  - `protocolVersion` – Версия протокола, на котором работает сервер. Можно найти [здесь](https://minecraft.wiki/w/Minecraft_Wiki:Projects/wiki.vg_merge/Protocol_History)

> [!NOTE]
> Пока что сервис может некорректно работать с `SRV` записями в DNS хостнейма, который используется для подключения. Для корректной работы порт должен совпадать с портом в `SRV` записи.

#### Успешное выполнение (код 200) означат, что сервис смог авторизоваться на серверах Mojang, подключиться к Minecraft серверу и установить с ним зашифрованное соединение.
Пример успешного ответа:
```json
{
    "nickname": "AndcoolSystems",
    "UUID": "1420c63c-b111-4453-993f-b3479ba1d4c6"
}
```
Ответ от API содержит никнейм и UUID, которые сервис получил от сервера Minecraft.

### Возможные ошибки
#### Ошибки парсинга JSON Body
`Status code: 422` – Неправильный формат JSON
```json
{
    "message": "Couldn't parse JSON body"
}
```    

`Status code: 400` – Один или несколько обязательных ключей в JSON не найден
```json
{
    "message": "Field with key `{key}` not found"
}
```
> [!WARNING]
> Валидация данных на стороне сервиса очень слабая, поэтому основной упор на валидацию должен делаться на промежуточные API.

#### Ошибки при входе
Ошибки при авторизации в Mojang:    
```json
{
    "message": "Mojang API error"
}
```    

Ошибки подключения к серверу:  
`Status code: 504` – Истекло время ожидания ответа от сервера
```json
{
    "message": "Gateway timeout"
}
```    

`Status code: 400` – Имя хоста не может быть разрешено
```json
{
    "message": "Unknown host"
}
```    

**Ошибки, связанные с отключением от сервера:**  
`Status code: 403`  
```json
{
    "cause": "Whitelist",
    "raw": "You not whitelisted on this server!"
}
```  
Ключ `raw` содержит сырое сообщение, которое было получено от сервера.  
Ключ `cause` содержит **предполагаемую** причину отключения. Так сервера могут быть настроены по-разному, поэтому эта причина может отражать неправильную информацию. Если определить причину не получается, он будет иметь значение `Disconnected`.

> [!WARNING]
> ЭТОТ ПРОЕКТ НАХОДИТСЯ В РАННЕЙ БЕТЕ И ОШИБКИ БУДУТ ИСПРАВЛЯТЬСЯ В ПРОЦЕССЕ РАЗРАБОТКИ!


---
**by AndcoolSystems with ❤, January 8, 2025**